---
# tasks file for ./ansible/roles/technohouser.bootstrap-common

# Mechanical hard drives can be slow, so ensure the lxc is in a ready state
- name: Wait for connection
  ansible.builtin.wait_for_connection:
    connect_timeout: 5
    delay: 10
    sleep: 5
    timeout: 120

- name: Setup apt-cacher proxy
  ansible.builtin.import_role:
    name: debops.debops.apt_proxy

- name: Set up timesyncd
  ansible.builtin.import_role:
    name: stuvusIT.systemd-timesyncd

- name: Configure locale for en_us.utf8
  ansible.builtin.import_role:
    name: robertdebock.roles.locale

- name: Prep to be managed by ansible
  ansible.builtin.import_role:
    name: robertdebock.roles.bootstrap

- name: Install build tools for homebrew and other downstream dependencies
  ansible.builtin.import_role:
    name: robertdebock.roles.buildtools

- name: Configure automatic updates for apt/yum
  ansible.builtin.import_role:
    name: robertdebock.roles.auto_update

- name: Install system level personal favorite packages
  ansible.builtin.import_role:
    name: GROG.package

- name: Change root password
  ansible.builtin.user:
    name: "root"
    update_password: on_create
    password: "{{ ansible.password | ansible.builtin.password_hash }}"
    state: present

- name: Create service account user
  ansible.builtin.import_role:
    name: buluma.roles.users

- name: Add ansible service key to authorized users file in service account
  ansible.posix.authorized_key:
    user: "{{ ansible.domain_user }}"
    key: "{{ ansible.pub_key }}"

- name: Add administrator pub key
  ansible.posix.authorized_key:
    user: "{{ ansible.domain_user }}"
    key: "{{ users[0]['pub_key'] }}"

- name: Add ansible service key to authorized users file in root
  ansible.posix.authorized_key:
    user: "{{ ansible.domain_user }}"
    key: "{{ ansible.pub_key }}"
