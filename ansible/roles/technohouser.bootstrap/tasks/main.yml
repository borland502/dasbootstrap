---
- name: Wait for connection
  ansible.builtin.wait_for_connection:
    connect_timeout: 5
    delay: 10
    sleep: 5
    timeout: 120

- name: Gather facts
  ansible.builtin.setup:

- name: Get home directory
  ansible.builtin.set_fact:
    home_dir: "{{ ansible_env.HOME }}"

- name: Prep to be managed by ansible
  ansible.builtin.import_role:
    name: robertdebock.roles.bootstrap

- name: Configure locale
  ansible.builtin.import_role:
    name: robertdebock.roles.locale
  notify: Reboot
  tags: molecule-notest

- name: Install pyenv
  ansible.builtin.import_role:
    name: staticdev.pyenv

- name: Install python tools
  ansible.builtin.import_role:
    name: staticdev.python-developer

- name: Ensure apt proxy configuration
  ansible.builtin.copy:
    content: |
      Acquire::http { Proxy "{{ apt_cacher_ng }}"; }
    dest: /etc/apt/apt.conf.d/proxy
    owner: root
    group: root
    mode: "0644"

- name: Install minimal Personal favorite packages for root user
  become: true
  ansible.builtin.apt:
    name:
      - zsh
      - systemd
      - systemd-cron
      - systemd-resolved
      - systemd-timesyncd
      - vim
      - git
      - curl
      - p7zip-full
      - packagekit
      - rsync
      - apt-transport-https
      - fonts-firacode
    state: present
    update_cache: true
  tags: molecule-idempotence-notest

- name: Configure package manager to auto-update
  ansible.builtin.import_role:
    name: robertdebock.roles.auto_update
  tags: molecule-notest

- name: Install build tools for homebrew and other downstream dependencies
  ansible.builtin.import_role:
    name: robertdebock.roles.buildtools

- name: Create service account user
  become: true
  ansible.builtin.import_role:
    name: buluma.roles.users
  tags: molecule-idempotence-notest

- name: Add ansible service key to authorized users file in service account
  ansible.posix.authorized_key:
    user: "{{ ansible.user }}"
    key: "{{ ansible.pub_key }}"
  tags: molecule-notest

- name: Setup systemd-resolved
  ansible.builtin.import_role:
    name: bodsch.systemd.resolved

- name: Setup sleep settings -- relaying on groups to use the right variables
  ansible.builtin.import_role:
    name: bodsch.systemd.sleep

- name: Setup ntp servers
  ansible.builtin.import_role:
    name: bodsch.systemd.timesyncd
  notify: Reboot
  tags: molecule-notest

- name: Change root password
  ansible.builtin.user:
    name: "root"
    update_password: on_create
    password: "{{ ansible.password | ansible.builtin.password_hash }}"
    state: present
  tags: molecule-idempotence-notest